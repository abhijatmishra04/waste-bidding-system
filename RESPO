package com.bofa.sst.batch.core.impl;

import com.bofa.sst.batch.constants.CustaggSQLFactory;
import com.bofa.sst.batch.model.CustaggProcessedRecordsDTO;
import lombok.extern.log4j.Log4j2;
import org.springframework.batch.item.ItemWriter;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.jdbc.core.JdbcTemplate;
import org.springframework.stereotype.Component;

import java.sql.Timestamp;
import java.time.Instant;
import java.util.ArrayList;
import java.util.Date;
import java.util.List;

@Component
@Log4j2
public class CustaggWriter implements ItemWriter<CustaggProcessedRecordsDTO> {

    @Autowired
    private JdbcTemplate jdbcTemplate;

    @Override
    public void write(List<? extends CustaggProcessedRecordsDTO> items) throws Exception {
        log.info("CustaggWriter: Writing {} records to the database.", items.size());

        // Collect all schedule IDs and xfer_exeq_m2m IDs from processed records
        List<String> allScheduleIds = new ArrayList<>();
        List<String> allXferExeqM2mIds = new ArrayList<>();
        
        for (CustaggProcessedRecordsDTO record : items) {
            if (record.getScheduleIds() != null) {
                allScheduleIds.addAll(record.getScheduleIds());
            }
            if (record.getXferExeqM2mIds() != null) {
                allXferExeqM2mIds.addAll(record.getXferExeqM2mIds());
            }
        }

        // Perform batch updates for schedule_m2m
        if (!allScheduleIds.isEmpty()) {
            updateScheduleM2M(allScheduleIds);
            log.info("CustaggWriter: Successfully updated {} ScheduleM2M records.", allScheduleIds.size());
        } else {
            log.warn("CustaggWriter: No Schedule IDs to update in ScheduleM2M.");
        }

        // Perform batch updates for transfer_execution_m2m
        if (!allXferExeqM2mIds.isEmpty()) {
            updateTransferExecutionM2M(allXferExeqM2mIds);
            log.info("CustaggWriter: Successfully updated {} TransferExecutionM2M records.", allXferExeqM2mIds.size());
        } else {
            log.warn("CustaggWriter: No TransferExecutionM2M IDs to update.");
        }
    }

    private void updateScheduleM2M(List<String> scheduleIds) {
        String updateQuery = CustaggSQLFactory.UPDATE_SCHEDULE_M2M;

        // Prepare parameters for batch update
        List<Object[]> batchParams = new ArrayList<>();
        Date currentDate = new Date();
        Timestamp currentTimestamp = Timestamp.from(Instant.now());

        for (String scheduleId : scheduleIds) {
            batchParams.add(new Object[]{currentDate, "CUSTAGG", currentTimestamp, scheduleId});
        }

        // Execute batch update
        jdbcTemplate.batchUpdate(updateQuery, batchParams);
        log.info("CustaggWriter: Executed batch update for {} Schedule IDs.", scheduleIds.size());
    }

    private void updateTransferExecutionM2M(List<String> xferExeqM2mIds) {
        String updateQuery = CustaggSQLFactory.UPDATE_TRANSFER_EXECUTION_M2M;

        // Prepare parameters for batch update
        List<Object[]> batchParams = new ArrayList<>();
        Timestamp currentTimestamp = Timestamp.from(Instant.now());

        for (String xferExeqM2mId : xferExeqM2mIds) {
            batchParams.add(new Object[]{"CUSTAGG", currentTimestamp, xferExeqM2mId});
        }

        // Execute batch update
        jdbcTemplate.batchUpdate(updateQuery, batchParams);
        log.info("CustaggWriter: Executed batch update for {} TransferExecutionM2M IDs.", xferExeqM2mIds.size());
    }
}



public static final String UPDATE_TRANSFER_EXECUTION_M2M = 
    "UPDATE sst_owner.transfer_execution_m2m temm " +
    "SET temm.act_indct = 'F', temm.updt_by = ?, temm.updt_ts = ? " +
    "WHERE temm.xfer_exeq_m2m_id = ?";

