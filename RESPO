package com.bofa.sst.batch.core.impl;

import com.bofa.sst.batch.constants.CustaggSQLFactory;
import com.bofa.sst.batch.model.CustaggProcessedRecordsDTO;
import lombok.extern.log4j.Log4j2;
import org.springframework.batch.item.ItemWriter;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.jdbc.core.JdbcTemplate;
import org.springframework.stereotype.Component;

import java.sql.Timestamp;
import java.util.ArrayList;
import java.util.Date;
import java.util.List;

@Component
@Log4j2
public class CustaggWriter implements ItemWriter<CustaggProcessedRecordsDTO> {

    @Autowired
    private JdbcTemplate jdbcTemplate;

    @Override
    public void write(List<? extends CustaggProcessedRecordsDTO> items) throws Exception {
        log.info("CustaggWriter: Writing {} records to the database.", items.size());

        // Collect all Schedule IDs from the processed records
        List<String> allScheduleIds = new ArrayList<>();
        for (CustaggProcessedRecordsDTO record : items) {
            if (record.getScheduleId() != null) {
                allScheduleIds.add(record.getScheduleId());
            }
        }

        // Perform batch update
        if (!allScheduleIds.isEmpty()) {
            updateScheduleM2M(allScheduleIds);
            log.info("CustaggWriter: Successfully updated {} ScheduleM2M records.", allScheduleIds.size());
        } else {
            log.warn("CustaggWriter: No Schedule IDs to update.");
        }
    }

    private void updateScheduleM2M(List<String> scheduleIds) {
        String updateQuery = CustaggSQLFactory.UPDATE_SCHEDULE_M2M;

        // Prepare parameters for batch update
        List<Object[]> batchParams = new ArrayList<>();
        Date currentDate = new Date(System.currentTimeMillis());
        Timestamp currentTimestamp = new Timestamp(System.currentTimeMillis());

        for (String scheduleId : scheduleIds) {
            batchParams.add(new Object[]{currentDate, currentTimestamp, scheduleId});
        }

        // Execute batch update
        jdbcTemplate.batchUpdate(updateQuery, batchParams);
        log.info("CustaggWriter: Executed batch update for {} Schedule IDs.", scheduleIds.size());
    }
}
