import org.springframework.batch.core.StepExecution;
import org.springframework.batch.core.annotation.BeforeStep;
import org.springframework.stereotype.Component;

import java.util.HashMap;

@Component
public class CustaggProcessor implements ItemProcessor<CustaggRecordsDTO, CustaggProcessedRecordsDTO> {

    private HashMap<String, String> entityMap;

    @Override
    public CustaggProcessedRecordsDTO process(CustaggRecordsDTO item) throws Exception {
        if (entityMap == null || entityMap.isEmpty()) {
            throw new IllegalStateException("Entity map is not available or is empty.");
        }

        // Extract data from the item
        String entityFromFile = item.getEntity().trim();
        String accountNumber = item.getAccountNumber();
        String productCode = item.getProductCode();

        Log.trace("CustaggProcessor: Processing record - Entity: {}, AccountNumber: {}, ProductCode: {}",
                entityFromFile, accountNumber, productCode);

        // Validate and enrich the record using the entityMap
        String mappedEntity = entityMap.get(entityFromFile);

        if (mappedEntity == null) {
            throw new IllegalArgumentException("No mapped entity found for: " + entityFromFile);
        }

        CustaggProcessedRecordsDTO enrichedRecord = new CustaggProcessedRecordsDTO();
        enrichedRecord.setMappedEntity(mappedEntity);
        enrichedRecord.setNumEntity(entityFromFile);
        enrichedRecord.setAccountNumber(accountNumber);
        enrichedRecord.setProductCode(productCode);

        Log.debug("CustaggProcessor: Enriched record details: {}", enrichedRecord);

        return enrichedRecord;
    }

    /**
     * This method retrieves the entityMap from the ExecutionContext before processing starts.
     */
    @BeforeStep
    public void beforeStep(StepExecution stepExecution) {
        // Retrieve the entity map from the ExecutionContext
        entityMap = (HashMap<String, String>) stepExecution.getExecutionContext().get("entityMap");

        if (entityMap == null || entityMap.isEmpty()) {
            Log.error("CustaggProcessor: Entity map is empty or not present in ExecutionContext.");
            throw new IllegalStateException("Entity map is not available or is empty.");
        }

        Log.info("CustaggProcessor: Retrieved entity map with {} entries from ExecutionContext.", entityMap.size());
    }
}
