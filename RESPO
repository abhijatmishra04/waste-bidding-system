import static org.junit.Assert.*;
import static org.mockito.Mockito.*;

import java.io.File;
import java.util.Map;

import org.junit.Before;
import org.junit.Test;
import org.junit.runner.RunWith;
import org.mockito.InjectMocks;
import org.mockito.Mock;
import org.mockito.MockitoAnnotations;
import org.springframework.test.context.junit4.SpringRunner;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.batch.item.ExecutionContext;

@RunWith(SpringRunner.class)
public class CustaggFilePartitionerTest {

    @InjectMocks
    private CustaggFilePartitioner partitioner;

    @Mock
    private OraOdsDynamicConfigPropertiesRepository mockConfigRepo;

    @Value("${custag.input.file.path}")
    private String filePath;

    @Value("#{JobExecutionContext['FilePrefixReferData']}")
    private String filePrefixReferData;

    @Value("#{JobExecutionContext['directoryPath']}")
    private String directoryPath;

    @Before
    public void setUp() {
        MockitoAnnotations.initMocks(this);
        partitioner.filePath = "/tmp/testfile.dat";
        partitioner.FilePrefixReferData = "testfile";
        partitioner.directoryPath = "/tmp";
    }

    @Test
    public void testPartition_FileDoesNotExist() {
        File mockFile = mock(File.class);
        when(mockFile.exists()).thenReturn(false);

        Map<String, ExecutionContext> partitions = partitioner.partition(4);

        assertNotNull(partitions);
        assertTrue(partitions.isEmpty());
    }

    @Test
    public void testPartition_FileIsEmpty() {
        File mockFile = mock(File.class);
        when(mockFile.exists()).thenReturn(true);
        when(mockFile.length()).thenReturn(0L);

        Map<String, ExecutionContext> partitions = partitioner.partition(4);

        assertNotNull(partitions);
        assertTrue(partitions.isEmpty());
    }

    @Test
    public void testPartition_ValidFile() {
        File mockFile = mock(File.class);
        when(mockFile.exists()).thenReturn(true);
        when(mockFile.length()).thenReturn(1000L);

        int gridSize = 5;
        Map<String, ExecutionContext> partitions = partitioner.partition(gridSize);

        assertNotNull(partitions);
        assertEquals(gridSize, partitions.size());

        for (int i = 0; i < gridSize; i++) {
            ExecutionContext context = partitions.get("partition" + i);
            assertNotNull(context);
            assertTrue(context.containsKey("fromLine"));
            assertTrue(context.containsKey("toLine"));
            assertTrue(context.containsKey("numberOfRecords"));
        }
    }

    @Test
    public void testPartition_NoRecordsFound() {
        File mockFile = mock(File.class);
        when(mockFile.exists()).thenReturn(true);
        when(mockFile.length()).thenReturn(10L);

        Map<String, ExecutionContext> partitions = partitioner.partition(4);

        assertNotNull(partitions);
        assertTrue(partitions.isEmpty());
    }
}
